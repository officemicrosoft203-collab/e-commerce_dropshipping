<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <span class="navbar-brand">Painel Admin</span>
    <button class="btn btn-outline-light btn-sm" onclick="logout()">Sair</button>
  </div>
</nav>

<div class="container mt-4">

  <div class="card shadow mb-4">
    <div class="card-body">
      <h5 id="formTitle">Cadastrar Produto</h5>

      <input type="hidden" id="productId">

      <input id="name" class="form-control mb-2" placeholder="Nome">
      <input id="price" type="number" class="form-control mb-2" placeholder="Preço">
      <textarea id="description" class="form-control mb-2" placeholder="Descrição"></textarea>

      <input type="file" id="image" class="form-control mb-3">

      <button class="btn btn-success w-100" onclick="save()">Salvar</button>
    </div>
  </div>

  <div class="card shadow">
    <div class="card-body">
      <h5>Produtos</h5>

      <table class="table table-striped">
        <thead>
          <tr>
            <th>Imagem</th>
            <th>Nome</th>
            <th>Preço</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const token = localStorage.getItem("token");
if (!token) window.location.href = "login.html";

function loadProducts() {
  fetch("http://localhost:3000/api/products")
    .then(res => res.json())
    .then(products => {
      table.innerHTML = "";
      products.forEach(p => {
        table.innerHTML += `
          <tr>
            <td>
              ${p.image ? `<img src="http://localhost:3000/uploads/${p.image}" width="60">` : ""}
            </td>
            <td>${p.name}</td>
            <td>R$ ${p.price}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="remove(${p.id})">Excluir</button>
            </td>
          </tr>
        `;
      });
    });
}

loadProducts();

function save() {
  const formData = new FormData();
  formData.append("name", name.value);
  formData.append("price", price.value);
  formData.append("description", description.value);
  if (image.files[0]) formData.append("image", image.files[0]);

  const id = productId.value;
  const url = id
    ? `http://localhost:3000/api/products/${id}`
    : "http://localhost:3000/api/products";

  const method = id ? "PUT" : "POST";

  fetch(url, {
    method,
    headers: { "Authorization": "Bearer " + token },
    body: formData
  }).then(() => {
    name.value = "";
    price.value = "";
    description.value = "";
    image.value = "";
    productId.value = "";
    loadProducts();
  });
}

function remove(id) {
  if (!confirm("Excluir produto?")) return;

  fetch(`http://localhost:3000/api/products/${id}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  }).then(() => loadProducts());
}

function logout() {
  localStorage.removeItem("token");
  window.location.href = "login.html";
}
</script>

</body>
</html>
